{% extends "main.html" %}

{% from "macros/header-block.j2" import header_block %}
{% from "macros/buttons.j2" import btn %}

{% block title %} M. DOCENTE | SGAPA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/asistencia.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="assistance" id="asistencia">

        {{ header_block('app_registration', 'Asistencia', 'var(--color-orange-card)') }}
        <form  action="" method="post" id="asistencia-form">
            <div class="assistance__group">
                <div class="group">
                    <label for="grados-select">Grupo:</label>
                    <select id="grados-select" name="grados" aria-label="Selecciona un grado">
                        <option value="">Seleccionar</option>
                        <option value="6">Grado Sexto </option>
                        <option value="7">Grado Séptimo</option>
                        <option value="8">Grado Octavo</option>
                        <option value="8">Grado Noveno</option>
                        <option value="10">Grado Décimo</option>
                        <option value="11">Grado Undécimo</option>
                    </select>
                </div>
                <div class="subjects">
                    <label for="grados-select">Asignatura:</label>
                    <select id="asignatura-select" name="grados" aria-label="Selecciona una asignatura">
                        <option value="">Seleccionar</option>
                        <option value="1">Matemáticas</option>
                        <option value="2">Castellano</option>
                        <option value="3">Tecnología</option>
                        <option value="4">Ética</option>
                        <option value="5">Artistica</option>
                    </select>
                </div>
                <div class="period">
                    <label for="periodos-select">Periodo:</label>
                    <select id="periodos-select" name="periodos" aria-label="Selecciona un Periodo">
                        <option value="">Seleccionar</option>
                        <option value="1">Primero</option>
                        <option value="2">Segundo</option>
                        <option value="3">Tercero</option>
                        <option value="4">Cuarto</option>
                    </select>
                </div>
            </div>
            <div class="assistance__buttons">
                {{ btn(icono="add", texto="Cargar", color="load") }}
                {{ btn(icono="save", texto="Guardar", color="save") }}
                {{ btn(icono="delete", texto="Eliminar", color="delete") }}
                {{ btn(icono="eye_tracking ", texto="Ver Notas", color="view") }}
            </div>
            <div class="assistance__notes">
                <table class="table__edit">
                    <thead>
                        <tr>
                            <th class="table__name">Apellidos</th>
                            <th class="table__name">Nombres</th>
                            <th class="table__notes">Ausente</th>
                            <th class="table__notes">Retardo</th>
                            <th class="table__notes">Fuga</th>
                            <th class="table__notes">Excusa</th>
                            <th class="table__notes">Total</th>
                            <th class="table__name">Observación</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-asistencia">
                        <!-- Aquí se cargan los estudiantes -->
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
    function confirmLogout() {
        window.location.href = "{{ url_for('auth.logout') }}";
    }

    function showModal(title, message, action) {
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalMessage").innerText = message;
        window.modalAction = action;

        const modal = document.getElementById("confirmModal");
        modal.style.display = "flex";
    }
    document.getElementById("modalConfirm").addEventListener("click", function () {
        if (typeof modalAction === 'function') {
            modalAction();
        }
        document.getElementById("confirmModal").style.display = "none";
    });

    document.getElementById("modalCancel").addEventListener("click", function () {
        document.getElementById("confirmModal").style.display = "none";
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("asistencia-form");
        const gradoSelect = document.getElementById("grados-select");
        const asignaturaSelect = document.getElementById("asignaturas-select");
        const tbody = document.getElementById("tabla-asistencia");

        // Cargar alumnos cuando se envíe el formulario
        form.addEventListener("submit", function (e) {
            e.preventDefault();
            const grupo = gradoSelect.value;
            const asignatura = asignaturaSelect.value;

            fetch(`/cargar-alumnos?grupo=${grupo}`)
                .then(res => res.json())
                .then(alumnos => {
                    tbody.innerHTML = "";
                    alumnos.forEach(alumno => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                        <td>${alumno.apellido}</td>
                        <td>${alumno.nombre}</td>
                        
                        <td><input type="checkbox" class="attendance-check" data-id="${alumno.student_id}" data-type="ausente"></td>
                        <td><input type="checkbox" class="attendance-check" data-id="${alumno.student_id}" data-type="tarde"></td>
                        <td><input type="checkbox" class="attendance-check" data-id="${alumno.student_id}" data-type="fuga"></td>
                        <td><input type="checkbox" class="attendance-check" data-id="${alumno.student_id}" data-type="justificado"></td>
                        <td><input type="text" class="observation-input" data-id="${alumno.student_id}" placeholder="Observación..."></td>
                    `;
                        tbody.appendChild(tr);
                    });
                });
        });

        // Manejar cambios de checkboxes
        tbody.addEventListener("change", function (e) {
            if (e.target.classList.contains("attendance-check")) {
                const studentId = e.target.getAttribute("data-id");
                const type = e.target.getAttribute("data-type");

                // Desactivar otros checkboxes del mismo estudiante
                const allChecks = document.querySelectorAll(`.attendance-check[data-id='${studentId}']`);
                allChecks.forEach(cb => {
                    if (cb !== e.target) cb.checked = false;
                });

                // Guardar estado actual
                window.attendanceData = window.attendanceData || [];
                const index = window.attendanceData.findIndex(d => d.student_id == studentId);

                const payload = {
                    student_id: parseInt(studentId),
                    subject_id: parseInt(document.getElementById("asignaturas-select").value),
                    status: type
                };

                if (index > -1) {
                    window.attendanceData[index] = payload;
                } else {
                    window.attendanceData.push(payload);
                }
            }
        });

        // Enviar datos al hacer clic en "Guardar"
        document.querySelector(".btn--save").addEventListener("click", function () {
            fetch("/guardar-asistencia", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(window.attendanceData || [])
            }).then(res => res.json()).then(data => {
                alert("Asistencia guardada correctamente.");
            });
        });
    });
</script>
{% endblock %}

{% endblock %}