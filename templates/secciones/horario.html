{% extends "main.html" %}
{% include "components/modal.html" %}
{% from "macros/macros.j2" import header %}
{% from "macros/buttons.j2" import btn with context %}
{% block title %} M. ADMINISTRADOR | SGAPA {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/horario.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    {{ header(titulo="Horario Grupos", color__fondo="var(--color-pink)") }}
    <div class="grid-layout">
        <main class="main-content">
            <div class="controls">
                <div class="controls-grid">
                    <div class="form-group">
                        <label for="grados-select">Grado:</label>
                        <select id="grados-select" name="grados" class="form-select" aria-label="Selecciona un grado">
                            <option value="">Seleccionar</option>
                            <option value="6">Grado Sexto</option>
                            <option value="7">Grado S√©ptimo</option>
                            <option value="8">Grado Octavo</option>
                            <option value="9">Grado Noveno</option>
                            <option value="10">Grado D√©cimo</option>
                            <option value="11">Grado Und√©cimo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="docente-select">Director</label>
                        <select id="docente-select" name="docente" class="form-select"
                            aria-label="Selecciona un director de grupo">
                            <option value="">Seleccionar</option>
                            <option value="Jhon F. Hidalgo">Jhon F. Hidalgo Arango</option>
                            <option value="Alejandra Marin">Alejandra Hidalgo Arango</option>
                            <option value="Sofia Giraldo">Sofia Giraldo Hidalgo</option>
                            <option value="Amparo Pineda">Amparo Pineda Ramirez</option>
                            <option value="Jorge Armando G.">Jorge Armando Giraldo</option>
                        </select>
                    </div>
                </div>
                <div class="stats-container">
                    <div class="stat-item">
                        <div class="stat-value" id="total-horas">0</div>
                        <div class="stat-label">Horas Asignadas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="horas-restantes">40</div>
                        <div class="stat-label">Horas Restantes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="porcentaje-completado">0%</div>
                        <div class="stat-label">Completado</div>
                    </div>
                </div>
            </div>
            <div class="schedule-container">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Horario</th>
                            <th>Lunes</th>
                            <th>Martes</th>
                            <th>Mi√©rcoles</th>
                            <th>Jueves</th>
                            <th>Viernes</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-horario">
                        <!-- Las filas se generar√°n din√°micamente -->
                    </tbody>
                </table>
            </div>

            <div class="actions">
                <div class="actions-grid">
                    {{ btn(icono="add", texto="Agregar", color="load", id="agregar-hora") }}
                    {{ btn(icono="save", texto="Guardar", color="save", tipo="submit") }}
                    {{ btn(icono="delete", texto="Borrar", color="delete", tipo="reset" ) }}
                    <button class="btn btn-primary">
                        <span>üñ®Ô∏è</span>
                        Imprimir
                    </button>
                </div>
            </div>
        </main>
        <aside class="sidebar">
            <div class="sidebar__title">
                <h3>Asignaci√≥n de Materias</h3>
                <h3>(Sexto - Noveno)</h3>
            </div>
            <table class="subjects-table" id="tablaMaterias">
                <thead>
                    <tr>
                        <th>Materia</th>
                        <th>Progreso</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="subject-name">Castellano</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/5</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Ingl√©s</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/4</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Matem√°ticas</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/4</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">C. Sociales</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/3</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Historia y Geograf√≠a</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/3</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Art√≠stica</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/2</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Biolog√≠a</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/2</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">E. F√≠sica</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/2</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Tecnolog√≠a</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/2</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">C. Lectora</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/1</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">C√°tedra de Paz</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/1</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">√âtica</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/1</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Estad√≠stica</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/1</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">F√≠sica</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/1</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Geometr√≠a</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/1</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Qu√≠mica</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/1</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="subject-name">Religi√≥n</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/1</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr class="break-row">
                        <td class="subject-name">Descanso</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/5</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                    <tr class="break-row">
                        <td class="subject-name">Almuerzo</td>
                        <td class="subject-hours">
                            <span class="hours-badge">0/5</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </aside>
    </div>
</div>

{% block extra_js %}
<script>
    // === 1. Funci√≥n confirmLogout() - Salir
    function confirmLogout() {
        window.location.href = "{{ url_for('auth.logout') }}";
    }

    // === 2. Funci√≥n showModal() - Modal personalizado
    function showModal(title, message, action) {
        const modal = document.getElementById("confirmModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalMessage = document.getElementById("modalMessage");

        if (!modal || !modalTitle || !modalMessage) {
            console.error("No se encontr√≥ uno o m√°s elementos del modal");
            alert(`Error: ${message}`);
            return;
        }

        modalTitle.innerText = title;
        modalMessage.innerText = message;
        window.modalAction = action;

        modal.style.display = "flex";
    }

    // === 3. Eventos del modal (Aceptar / Cancelar)
    document.addEventListener("DOMContentLoaded", function () {
        const modalConfirm = document.getElementById("modalConfirm");
        const modalCancel = document.getElementById("modalCancel");

        if (modalConfirm) {
            modalConfirm.addEventListener("click", function () {
                if (typeof modalAction === 'function') {
                    modalAction();
                }
                document.getElementById("confirmModal").style.display = "none";
            });
        }

        if (modalCancel) {
            modalCancel.addEventListener("click", function () {
                document.getElementById("confirmModal").style.display = "none";
            });
        }

        // === 4. Validaci√≥n de campos vac√≠os desde Flask ===
        const urlParams = new URLSearchParams(window.location.search);
        const camposVacios = urlParams.get('campos_vacios');

        if (camposVacios) {
            const listaCampos = camposVacios.split(',');
            listaCampos.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.classList.add('input-error');
                }
            });
        }

        // === 5. Limpiar error al escribir ===
        document.querySelectorAll('.registration__form input, .registration__form select').forEach(input => {
            input.addEventListener('input', function () {
                this.classList.remove('input-error');
            });
        });
    });
</script>
<script>
    const materias = [
        { nombre: "Matem√°ticas", color: "#667eea" },
        { nombre: "Geometr√≠a", color: "#764ba2" },
        { nombre: "Estad√≠stica", color: "#f093fb" },
        { nombre: "Tecnolog√≠a", color: "#4ecdc4" },
        { nombre: "Castellano", color: "#45b7d1" },
        { nombre: "C. Lectora", color: "#96ceb4" },
        { nombre: "Ingl√©s", color: "#ffeaa7" },
        { nombre: "Biolog√≠a", color: "#55a3ff" },
        { nombre: "F√≠sica", color: "#fd79a8" },
        { nombre: "Qu√≠mica", color: "#fdcb6e" },
        { nombre: "Art√≠stica", color: "#e17055" },
        { nombre: "√âtica", color: "#a29bfe" },
        { nombre: "Religi√≥n", color: "#fd7f6e" },
        { nombre: "C√°tedra de Paz", color: "#74b9ff" },
        { nombre: "E. F√≠sica", color: "#00b894" },
        { nombre: "C. Sociales", color: "#fdaf6e" },
        { nombre: "Historia y Geograf√≠a", color: "#e84393" },
        { nombre: "Descanso", color: "#b2bec3" },
        { nombre: "Almuerzo", color: "#ddd6d6" }
    ];


    const dias = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes"];

    const seleccionContador = {};
    let totalHorasAsignadas = 0;
    const TOTAL_HORAS_DISPONIBLES = 40;


    const subjectRows = document.querySelectorAll('#tablaMaterias tbody tr');
    subjectRows.forEach(row => {
        const materia = row.cells[0].textContent.trim();
        const maxAsignaciones = parseInt(row.cells[1].querySelector('.hours-badge').textContent.split('/')[1]);
        seleccionContador[materia] = { count: 0, max: maxAsignaciones };
    });

    // Funci√≥n para mostrar mensajes
    function mostrarMensaje(mensaje, tipo = 'error') {
        const messageDiv = document.createElement('div');
        messageDiv.className = tipo === 'error' ? 'error-message' : 'success-message';
        messageDiv.textContent = mensaje;

        const controls = document.querySelector('.controls');
        controls.insertAdjacentElement('afterend', messageDiv);

        setTimeout(() => messageDiv.remove(), 4000);
    }

    // Funci√≥n para parsear hora a objeto Date
    function parseTime(timeStr) {
        const [hours, minutes] = timeStr.split(":").map(Number);
        const date = new Date();
        date.setHours(hours, minutes, 0, 0);
        return date;
    }

    // Funci√≥n para generar una fila de horario
    function generarFila(horaInicio = "07:00", horaFin = "08:00") {
        const fila = document.createElement('tr');
        const celdaHora = document.createElement('td');
        celdaHora.className = 'time-container';
        celdaHora.innerHTML = `
                <div class="time" data-time="${horaInicio}">${horaInicio}</div>
                <div class="time" data-time="${horaFin}">${horaFin}</div>
            `;
        fila.appendChild(celdaHora);

        // Celdas de d√≠as
        dias.forEach(dia => {
            const celdaDia = document.createElement('td');
            const select = document.createElement('select');
            select.className = 'subject-select';
            select.setAttribute('aria-label', `${dia} - ${horaInicio} a ${horaFin}`);

            // Opci√≥n por defecto
            const opcionDefault = document.createElement('option');
            opcionDefault.value = "";
            opcionDefault.textContent = "Seleccionar";
            select.appendChild(opcionDefault);

            // Opciones din√°micas
            materias.forEach(materia => {
                const opcion = document.createElement('option');
                opcion.value = materia.nombre;
                opcion.textContent = materia.nombre;
                opcion.style.backgroundColor = materia.color;
                opcion.style.color = 'white';
                select.appendChild(opcion);
            });

            celdaDia.appendChild(select);
            fila.appendChild(celdaDia);
        });

        return fila;
    }

    // Hacer las horas editables
    function hacerHorasEditables() {
        document.querySelectorAll('.time').forEach(time => {
            time.addEventListener('click', () => {
                const currentTime = time.dataset.time;
                const input = document.createElement('input');
                input.type = 'time';
                input.value = currentTime;
                input.className = 'time-input';

                time.textContent = '';
                time.appendChild(input);
                input.focus();

                input.addEventListener('blur', () => {
                    const newTime = input.value || currentTime;
                    if (validarHora(newTime, time)) {
                        time.dataset.time = newTime;
                        time.textContent = newTime;
                        mostrarMensaje('Hora actualizada correctamente', 'success');
                    } else {
                        time.textContent = currentTime;
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') input.blur();
                    if (e.key === 'Escape') {
                        time.textContent = currentTime;
                    }
                });
            });
        });
    }

    // Validar que la nueva hora sea v√°lida
    function validarHora(hora, timeElement) {
        const fila = timeElement.closest('tr');
        const horas = fila.querySelectorAll('.time');

        if (horas.length === 2) {
            const horaInicio = parseTime(horas[0].dataset.time);
            const horaFin = parseTime(horas[1].dataset.time);

            if (horaInicio >= horaFin) {
                mostrarMensaje('La hora de inicio debe ser menor que la hora de fin');
                return false;
            }
        }

        return true;
    }

    // Actualizar progreso visual de materias
    function actualizarProgreso(materia) {
        const contador = seleccionContador[materia];
        const row = Array.from(document.querySelectorAll('#tablaMaterias tbody tr')).find(
            tr => tr.cells[0].textContent.trim() === materia
        );

        if (row) {
            const badge = row.querySelector('.hours-badge');
            const progressFill = row.querySelector('.progress-fill');
            const porcentaje = (contador.count / contador.max) * 100;

            badge.textContent = `${contador.count}/${contador.max}`;
            progressFill.style.width = `${porcentaje}%`;

            // Cambiar color seg√∫n el progreso
            if (porcentaje === 100) {
                progressFill.style.background = 'linear-gradient(90deg, #48bb78, #38a169)';
            } else if (porcentaje > 50) {
                progressFill.style.background = 'linear-gradient(90deg, #ed8936, #dd6b20)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #667eea, #764ba2)';
            }
        }
    }

    // Actualizar estad√≠sticas generales
    function actualizarEstadisticas() {
        const totalElement = document.getElementById("total-horas");
        const restantesElement = document.getElementById("horas-restantes");
        const porcentajeElement = document.getElementById("porcentaje-completado");

        const horasRestantes = TOTAL_HORAS_DISPONIBLES - totalHorasAsignadas;
        const porcentaje = Math.round((totalHorasAsignadas / TOTAL_HORAS_DISPONIBLES) * 100);

        totalElement.textContent = totalHorasAsignadas;
        restantesElement.textContent = horasRestantes;
        porcentajeElement.textContent = `${porcentaje}%`;

        // Cambiar colores seg√∫n el progreso
        if (porcentaje === 100) {
            totalElement.style.color = 'var(--color-success)';
            porcentajeElement.style.color = 'var(--color-success)';
        } else if (porcentaje > 80) {
            totalElement.style.color = 'var(--color-warning)';
            porcentajeElement.style.color = 'var(--color-warning)';
        } else {
            totalElement.style.color = 'var(--color-primary)';
            porcentajeElement.style.color = 'var(--color-primary)';
        }
    }

    // Actualizar estados de los selects
    function actualizarSelect(select, materiaSeleccionada) {
        const materiaInfo = materias.find(m => m.nombre === materiaSeleccionada);
        if (materiaInfo) {
            select.style.backgroundColor = materiaInfo.color;
            select.style.color = 'white';
            select.style.fontWeight = '600';
        }

        // Actualizar opciones disponibles en todos los selects
        const selects = document.querySelectorAll('.subject-select');
        selects.forEach(s => {
            const options = s.options;
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.value) {
                    const contador = seleccionContador[option.value];
                    const isDisabled = contador.count >= contador.max;

                    option.disabled = isDisabled;
                    option.style.opacity = isDisabled ? '0.5' : '1';

                    if (isDisabled) {
                        option.textContent = `${option.value}`;
                    } else {
                        option.textContent = option.value;
                    }
                }
            }
        });
    }

    // Manejador de cambio de selecci√≥n de materias
    document.getElementById('tabla-horario').addEventListener('change', (e) => {
        if (e.target.classList.contains('subject-select')) {
            const select = e.target;
            const materiaSeleccionada = select.value;
            const materiaAnterior = select.dataset.materiaAnterior;

            // Restablecer si hab√≠a una materia anterior
            if (materiaAnterior) {
                seleccionContador[materiaAnterior].count--;
                actualizarProgreso(materiaAnterior);
                select.dataset.materiaAnterior = "";
                select.style.backgroundColor = "";
                select.style.color = "";
                select.style.fontWeight = "";
                totalHorasAsignadas--;
            }

            // Agregar nueva materia
            if (materiaSeleccionada) {
                const contador = seleccionContador[materiaSeleccionada];

                if (contador.count >= contador.max) {
                    mostrarMensaje(`Has alcanzado el l√≠mite de horas para ${materiaSeleccionada}`);
                    select.value = "";
                } else {
                    contador.count++;
                    actualizarProgreso(materiaSeleccionada);
                    actualizarSelect(select, materiaSeleccionada);
                    select.dataset.materiaAnterior = materiaSeleccionada;
                    totalHorasAsignadas++;

                    if (contador.count === contador.max) {
                        mostrarMensaje(`¬°${materiaSeleccionada} completada!`, 'success');
                    }
                }
            }

            actualizarEstadisticas();
        }
    });

    // A√±adir primera fila al cargar
    const tablaHorario = document.getElementById('tabla-horario');
    tablaHorario.appendChild(generarFila());
    hacerHorasEditables();

    // Bot√≥n para agregar filas
    document.getElementById('agregar-hora').addEventListener('click', () => {
        const ultimaFila = tablaHorario.lastElementChild;
        const ultimaHoraFin = ultimaFila.querySelector('.time:last-child').dataset.time;

        if (parseTime(ultimaHoraFin) >= parseTime("23:59")) {
            mostrarMensaje("No se pueden agregar m√°s horas despu√©s de las 23:59");
            return;
        }

        // Calcular siguiente hora autom√°ticamente
        const finTime = parseTime(ultimaHoraFin);
        finTime.setHours(finTime.getHours() + 1);
        const nuevaHoraFin = finTime.toTimeString().slice(0, 5);

        const nuevaFila = generarFila(ultimaHoraFin, nuevaHoraFin);
        tablaHorario.appendChild(nuevaFila);
        hacerHorasEditables();

        mostrarMensaje('Nueva hora agregada correctamente', 'success');
    });

    // Bot√≥n para limpiar horario
    document.querySelector('.btn__delete').addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro de que deseas limpiar todo el horario?')) {
            // Reiniciar contadores
            Object.keys(seleccionContador).forEach(materia => {
                seleccionContador[materia].count = 0;
                actualizarProgreso(materia);
            });

            totalHorasAsignadas = 0;
            actualizarEstadisticas();

            // Limpiar selects
            document.querySelectorAll('.subject-select').forEach(select => {
                select.value = "";
                select.style.backgroundColor = "";
                select.style.color = "";
                select.style.fontWeight = "";
                delete select.dataset.materiaAnterior;
            });

            // Actualizar opciones
            document.querySelectorAll('.subject-select').forEach(select => {
                actualizarSelect(select, "");
            });

            mostrarMensaje('Horario limpiado correctamente', 'success');
        }
    });

    // Funcionalidad de impresi√≥n
    document.querySelector('.btn-primary:last-child').addEventListener('click', () => {
        window.print();
    });

    // Validaci√≥n de formulario
    document.querySelectorAll('.form-select').forEach(select => {
        select.addEventListener('change', (e) => {
            if (e.target.value) {
                e.target.style.borderColor = 'var(--color-success)';
                e.target.style.backgroundColor = 'rgba(72, 187, 120, 0.05)';
            } else {
                e.target.style.borderColor = 'var(--color-gray-200)';
                e.target.style.backgroundColor = 'white';
            }
        });
    });

    // Inicializar estad√≠sticas
    actualizarEstadisticas();

    // Funcionalidad de guardado
    document.querySelector('.btn__save').addEventListener('click', () => {
        const grado = document.getElementById('grados-select').value;
        const docente = document.getElementById('docente-select').value;

        if (!grado || !docente) {
            mostrarMensaje('Por favor selecciona el grado y el director de grupo antes de guardar');
            return;
        }

        if (totalHorasAsignadas === 0) {
            mostrarMensaje('No hay horas asignadas para guardar');
            return;
        }

        // Aqu√≠ ir√≠a la l√≥gica de guardado real
        mostrarMensaje(`Horario guardado exitosamente para ${grado} con ${docente}`, 'success');
    });



</script>
{% endblock %}

{% endblock %}