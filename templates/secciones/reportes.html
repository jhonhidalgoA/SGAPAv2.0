{% extends "main.html" %}
{% include "components/modal.html" %}
{% from "macros/buttons.j2" import btn with context %}
{% block title %} M. DOCENTE | SGAPA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reportes.css') }}">
{% endblock %}
{% block content %}
<div class="container">
  <div class="header">
    <div class="icon__return">
      <a href="{{ url_for('dashboards.docente') }}" class="icon__link">
        <i class="material-symbols-outlined" aria-label="Table">arrow_back</i>
      </a>
    </div>
    <div class="title">
      <div class="row__title">
        <i class="material-symbols-outlined">picture_as_pdf</i>
        <h1>Reportes Académicos</h1>
      </div>
      <p>Sistema de Gestión Administrativa y Procesos Académicos (SGAPA) </p>
    </div>
    <div class="navbar__logo">
      <span onclick="showModal('', '¿Estás seguro de que deseas cerrar sesión?', confirmLogout)"
        class="icon material-symbols-outlined toggleBtn">
        logout
      </span>
    </div>
  </div>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <script>
    showModal("{{ category | title }}", "{{ message | safe}}", null);
  </script>
  {% endfor %}
  {% endif %}
  {% endwith %}
  <div class="report" id="reportes">
    <div class="report__group">
      <div class="group">
        <label for="grados-select">Grupo:</label>
        <select id="grados-select" name="grados" aria-label="Selecciona un grado">
          <option value="">Seleccionar</option>
          <option value="6">Grado Sexto </option>
          <option value="7">Grado Séptimo</option>
          <option value="8">Grado Octavo</option>
          <option value="8">Grado Noveno</option>
          <option value="10">Grado Décimo</option>
          <option value="11">Grado Undécimo</option>
        </select>
      </div>
      <div class="subjects">
        <label for="name-student">Estudiante:</label>
        <select id="name-student" name="name-student" aria-label="Selecciona una nombre">
          <option value="">Seleccionar</option>
          <!--aqui dinamicamente los nombres-->
        </select>
      </div>
      <div class="period">
        <label for="periodos-select">Periodo:</label>
        <select id="periodos-select" name="periodo" aria-label="Selecciona un Periodo">
          <option value="">Seleccionar</option>
          <option value="1">Primero</option>
          <option value="2">Segundo</option>
          <option value="3">Tercero</option>
          <option value="4">Cuarto</option>
        </select>
      </div>
    </div>
    <div class="report__type">
      <label for="report"> Tipo de Reporte:</label>
      <select id="report" name="report" aria-label="Selecciona un Reporte">
        <option value="">Seleccionar</option>
        <option value="boletin">Boletin de Calificaciones</option>
        <option value="certificado">Certificado Escolar</option>
        <option value="concentrador">Concentrador de Notas por Período</option>
        <option value="informe">Informe de Aprobación y Reprobación</option>
        <option value="plan">Plan de Ajuste Razonable PIAR</option>
      </select>
    </div>
    <div class="report__buttons">
      {{ btn(icono="picture_as_pdf", texto="Generar", color="generate", id="btn-generar-word") }}
    </div>
  </div>
</div>
{% block extra_js %}
<script>
  function confirmLogout() {
    window.location.href = "{{ url_for('auth.logout') }}";
  }

  function showModal(title, message, action) {
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalMessage").innerText = message;
    window.modalAction = action;

    const modal = document.getElementById("confirmModal");
    modal.style.display = "flex";
  }
  document.getElementById("modalConfirm").addEventListener("click", function () {
    if (typeof modalAction === 'function') {
      modalAction();
    }
    document.getElementById("confirmModal").style.display = "none";
  });

  document.getElementById("modalCancel").addEventListener("click", function () {
    document.getElementById("confirmModal").style.display = "none";
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Escuchar cambios en grado para cargar estudiantes
    const gradosSelect = document.getElementById('grados-select');
    const estudiantesSelect = document.getElementById('name-student');
    const reporteSelect = document.getElementById('report');
    const btnGenerar = document.getElementById('btn-generar-word');
    const periodo = document.getElementById('periodos-select').value || '1';

    // Cargar estudiantes cuando se selecciona un grupo
    gradosSelect.addEventListener('change', async function () {
      const grupo = this.value;
      if (!grupo) {
        estudiantesSelect.innerHTML = '<option value="">Selecciona un grupo primero</option>';
        estudiantesSelect.disabled = true;
        return;
      }

      estudiantesSelect.innerHTML = '<option value="">Cargando...</option>';
      estudiantesSelect.disabled = true;

      try {
        const res = await fetch(`/secciones/api/estudiantes/${grupo}`);
        const data = await res.json();

        if (!res.ok || !data.data || data.data.length === 0) {
          estudiantesSelect.innerHTML = '<option>No hay estudiantes</option>';
          return;
        }

        estudiantesSelect.innerHTML = '<option value="">Selecciona un estudiante</option>';

        data.data.forEach(est => {
          const option = document.createElement('option');
          option.value = est.student_id;
          option.textContent = est.full_name;
          estudiantesSelect.appendChild(option);
        });

        estudiantesSelect.disabled = false;

      } catch (error) {
        console.error("❌ Error al cargar estudiantes:", error);
        estudiantesSelect.innerHTML = '<option>Error al cargar</option>';
      }
    });

    // Habilitar botón solo si se selecciona Boletín + grado + estudiante
    function validarFormulario() {
      const grupo = gradosSelect.value;
      const estudiante = estudiantesSelect.value;
      const tipoReporte = reporteSelect.value;
      btnGenerar.disabled = !(grupo && estudiante && tipoReporte === 'boletin');
    }

    [gradosSelect, estudiantesSelect, reporteSelect].forEach(el => {
      el.addEventListener('change', validarFormulario);
    });

    // Generar boletín Word rellenado
    btnGenerar.addEventListener('click', async () => {
      const grupo = gradosSelect.value;
      const estudiante_id = estudiantesSelect.value;
      const periodo = document.getElementById('periodos-select').value || '1';

      if (!grupo || !estudiante_id) return alert("⚠️ Faltan datos");

      try {
        const response = await fetch('/secciones/generar-boletin-word', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ grupo, estudiante_id, periodo })
        });

        if (!response.ok) throw new Error("Error al generar el documento");

        const blob = await response.blob();
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = `boletin_${estudiante_id}.docx`;
        link.click();

      } catch (error) {
        alert(`❌ ${error.message}`);
      }
    });
  });
</script>
{% endblock %}
{% endblock %}