{% extends "main.html" %}
{% include "components/modal.html" %}
{% from "macros/macros.j2" import header %}
{% from "macros/buttons.j2" import btn with context %}
{% block title %} MODULO ADMINISTRADOR | SGAPA {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/registro_docente.css') }}">
{% endblock %}

{% block content %}
<div class="tabs">
    {{ header(titulo="Registro Docente", color__fondo="var(--color-green-emerald)") }}

    <ul class="tab-nav">
        <li class="active" data-tab="tab1">Datos del Docente</li>
        <li data-tab="tab2">Información Profesional</li>
    </ul>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <script>
        showModal("{{ category | title }}", "{{ message | safe}}", null);
    </script>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <form action="{{ url_for('secciones.guardar_docente') }}" method="post" id="teacherRegistrationForm"
        class="registration__form" enctype="multipart/form-data">
        <div class="tab-content active" id="tab1">
            <div class="student__photo">
                <div class="photo__container">
                    <label for="photo" class="photo__label">
                        <span>Foto del Docente</span>
                        <input type="file" id="photo" name="student_photo" accept="image/*">
                        <div class="photo__preview" id="photoPreview"></div>
                    </label>
                </div>
                <div class="registration__fields">
                    <h3>Datos del Docente</h3>
                    <div class="field__row">
                        <div class="group">
                            <label for="registration_date_teacher">Fecha de Registro:</label>
                            <input type="date" id="registration_date_teacher" name="registration_date_teacher" readonly>
                        </div>
                        <div class="group">
                            <label for="codigo_teacher">Código:</label>
                            <input type="number" id="codigo_teacher" name="codigo_teacher">
                        </div>
                        <div class="group">
                            <label for="teacher_name">Nombres:</label>
                            <input type="text" id="teacher_name" name="teacher_name">
                        </div>
                        <div class="group">
                            <label for="teacher_lastname">Apellidos:</label>
                            <input type="text" id="teacher_lastname" name="teacher_lastname">
                        </div>
                    </div>
                    <div class="field__row">
                        <div class="group">
                            <label for="teacher_birth_date">Fecha de Nacimiento:</label>
                            <input type="date" id="teacher_birth_date" name="teacher_birth_date">
                        </div>
                        <div class="group">
                            <label for="teacher_age">Edad:</label>
                            <input type="number" id="teacher_age" name="teacher_age">
                        </div>
                        <div class="group">
                            <label for="teacher_gender">Género:</label>
                            <select id="teacher_gender" name="teacher_gender">
                                <option value="">Seleccionar</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                                <option value="no_binario">No Binario</option>
                            </select>
                        </div>
                        <div class="group">
                            <label for="teacher_birth_place">Lugar de Nacimiento:</label>
                            <input type="text" id="teacher_birth_place" name="teacher_birth_place">
                        </div>
                    </div>
                    <div class="field__row">
                        <div class="group">
                            <label for="teacher_document_type">Tipo de Documento:</label>
                            <select id="teacher_document_type" name="teacher_document_type">
                                <option value="">Seleccionar</option>
                                <option value="cc">Cédula de Ciudadanía (CC)</option>
                                <option value="ce">Cédula de Extranjería (CE)</option>
                                <option value="pep">Permiso Especial de Permanencia (PEP)</option>
                            </select>
                        </div>
                        <div class="group">
                            <label for="teacher_document_number">Número de Documento:</label>
                            <input type="number" id="teacher_document_number" name="teacher_document_number">
                        </div>
                        <div class="group">
                            <label for="teacher_phone">Teléfono:</label>
                            <input type="tel" id="teacher_phone" name="teacher_phone">
                        </div>
                        <div class="group">
                            <label for="teacher_email">Correo Electrónico:</label>
                            <input type="email" id="teacher_email" name="teacher_email"
                                placeholder="ejemplo@dominio.com">
                        </div>
                    </div>
                    <div class="field__row">
                        <div class="group">
                            <label for="profession">Profesión:</label>
                            <input type="text" id="profession" name="profession">
                        </div>
                        <div class="group">
                            <label for="area">Área:</label>
                            <select id="area" name="area">
                                <option value="">Seleccionar</option>
                                <option value="algebra">Álgebra</option>
                                <option value="biologia">Biología</option>
                                <option value="calculo">Cálculo</option>
                                <option value="ciencias de la tierra">Ciencias de la Tierra</option>
                                <option value="constitucion politica">Constitución Política</option>
                                <option value="democracia y paz">Democracia y Paz</option>
                                <option value="educacion artistica">Educación Artística</option>
                                <option value="educacion fisica">Educación Física</option>
                                <option value="español">Español (Gramática, Literatura)</option>
                                <option value="estadistica">Estadística</option>
                                <option value="etica y valores humanos">Ética y Valores Humanos</option>
                                <option value="fisica">Física</option>
                                <option value="geografia">Geografía</option>
                                <option value="geometria">Geometría</option>
                                <option value="historia de colombia">Historia de Colombia</option>
                                <option value="ingles">Inglés (como lengua extranjera)</option>
                                <option value="quimica">Química</option>
                                <option value="tecnologia e informatica">Tecnología e Informática</option>
                            </select>
                        </div>
                        <div class="group">
                            <label for="resolucion">Número de Resolución:</label>
                            <input type="text" id="resolucion" name="resolucion">
                        </div>
                        <div class="group">
                            <label for="scale">Escalafón:</label>
                            <select id="scale" name="scale" required>
                                <option value="1a">1A</option>
                                <option value="1b">1B</option>
                                <option value="1c">1C</option>
                                <option value="1d">1D</option>
                                <option value="2a">2A</option>
                                <option value="2b">2B</option>
                                <option value="2c">2C</option>
                                <option value="2d">2D</option>
                                <option value="3a">3A</option>
                                <option value="3b">3B</option>
                                <option value="3c">3C</option>
                                <option value="3d">3D</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-content tab-2" id="tab2">
            <!-- Información Profesional -->
        </div>
        <div class="ratings__buttons">
            {{ btn(icono="save", texto="Guardar", color="save", tipo="submit") }}
            {{ btn(icono="picture_as_pdf", texto="Generar", color="generate") }}
            {{ btn(icono="delete", texto="Borrar", color="delete") }}
            {{ btn(icono="print", texto="Imprimir", color="print") }}
        </div>
    </form>
</div>

{% block extra_js %}
<script src="{{url_for('static', filename='js/photo-student.js') }}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const VALIDATIONS = {
            EMAIL_REGEX: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
            PHONE_REGEX: /^\d{9,}$/,
            DOCUMENT_REGEX: /^\d+$/,
            REQUIRED_FIELDS: [
                { id: "teacher_name", name: "Nombres" },
                { id: "teacher_lastname", name: "Apellidos" },
                { id: "teacher_document_type", name: "Tipo de Documento" },
                { id: "teacher_document_number", name: "Número de Documento" },
                { id: "teacher_email", name: "Correo Electrónico" },
                { id: "teacher_phone", name: "Teléfono" },
                { id: "scale", name: "Escalafón" }
            ]
        };
     

        const registrationDateInput = document.getElementById("registration_date_teacher");
        if (registrationDateInput) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, "0");
            const day = String(today.getDate()).padStart(2, "0");
            const todayStr = `${year}-${month}-${day}`;

            registrationDateInput.value = todayStr;
            registrationDateInput.max = todayStr; 
        }

        function calculateAge(birthDate) {
            const today = new Date();
            const birthDateObj = new Date(birthDate);
            
            if (isNaN(birthDateObj.getTime())) {
                return 0;
            }
            
            let age = today.getFullYear() - birthDateObj.getFullYear();
            const monthDiff = today.getMonth() - birthDateObj.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDateObj.getDate())) {
                age--;
            }
            
            return age;
        }

       
        const birthDateInput = document.getElementById("teacher_birth_date");
        const ageInput = document.getElementById("teacher_age");
        
        if (birthDateInput && ageInput) {
            birthDateInput.addEventListener("change", function() {
                const birthDate = this.value;
                const age = calculateAge(birthDate);
                ageInput.value = age > 0 ? age : "";
            });
        }

        const form = document.getElementById("teacherRegistrationForm");

        if (form) {
            form.addEventListener("submit", handleFormSubmit);
            setupInputListeners(form);
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            clearPreviousErrors();

            const validationResult = validateForm();

            if (!validationResult.isValid) {
                showError(validationResult.message, validationResult.focusElement);
                return;
            }

            submitForm();
        }

        function validateForm() {
            const missingFields = validateRequiredFields();

            if (missingFields.length > 0) {
                const firstMissingField = VALIDATIONS.REQUIRED_FIELDS.find(f =>
                    f.name === missingFields[0].replace("* ", "")
                );

                return {
                    isValid: false,
                    message: "Debe completar los siguientes campos obligatorios:\n\n" + missingFields.join("\n"),
                    focusElement: document.getElementById(firstMissingField?.id)
                };
            }

            const emailValidation = validateEmail();
            if (!emailValidation.isValid) return emailValidation;

            const phoneValidation = validatePhone();
            if (!phoneValidation.isValid) return phoneValidation;

            const documentValidation = validateDocument();
            if (!documentValidation.isValid) return documentValidation;

            return { isValid: true };
        }

        function validateRequiredFields() {
            const missingFields = [];

            VALIDATIONS.REQUIRED_FIELDS.forEach(field => {
                const input = document.getElementById(field.id);
                if (!input?.value.trim()) {
                    missingFields.push(field.name);
                    input?.classList.add('input-error');
                }
            });

            return missingFields;
        }

        function validateEmail() {
            const emailInput = document.getElementById("teacher_email");
            const email = emailInput?.value.trim();

            if (email && !VALIDATIONS.EMAIL_REGEX.test(email)) {
                emailInput.classList.add("input-error");
                return {
                    isValid: false,
                    message: "Por favor ingrese un correo electrónico válido.",
                    focusElement: emailInput
                };
            }

            return { isValid: true };
        }

        function validatePhone() {
            const phoneInput = document.getElementById("teacher_phone");
            const phone = phoneInput?.value.trim();

            if (phone && !VALIDATIONS.PHONE_REGEX.test(phone)) {
                phoneInput.classList.add("input-error");
                return {
                    isValid: false,
                    message: "Por favor ingrese un número de teléfono válido (mínimo 7 dígitos).",
                    focusElement: phoneInput
                };
            }

            return { isValid: true };
        }

        function validateDocument() {
            const docNumberInput = document.getElementById("teacher_document_number");
            const docNumber = docNumberInput?.value.trim();

            if (docNumber && !VALIDATIONS.DOCUMENT_REGEX.test(docNumber)) {
                docNumberInput.classList.add("input-error");
                return {
                    isValid: false,
                    message: "El número de documento debe contener solo números.",
                    focusElement: docNumberInput
                };
            }

            return { isValid: true };
        }

        function clearPreviousErrors() {
            document.querySelectorAll('.input-error').forEach(input => {
                input.classList.remove('input-error');
            });
        }

        function showError(message, focusElement) {
            showModal("Validación requerida", message, function () {
                focusElement?.focus();
            });
        }

        function submitForm() {
            const submitButton = form.querySelector("button[type=submit]");

            if (submitButton) {
                submitButton.disabled = true;
                form.submit();
                setTimeout(() => {
                    submitButton.disabled = false;
                }, 3000);
            } else {
                form.submit();
            }
        }

        function setupInputListeners(formElement) {
            formElement.querySelectorAll("input, select").forEach(input => {
                input.addEventListener("input", function () {
                    this.classList.remove("input-error");
                });
            });
        }
        
    });
</script>
{% endblock %}
{% endblock %}